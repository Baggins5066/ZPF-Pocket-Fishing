<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zombie Fishing</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; background: #333; }
        body { width: 100vw; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        canvas { display: block; max-width: 100vw; max-height: 100vh; margin: auto; }
    #backpackBtn:hover #backpackIcon {
        transform: scale(1.18) rotate(-8deg);
        filter: drop-shadow(0 4px 16px #44f);
    }
    #backpackBtn:active #backpackIcon {
        transform: scale(0.92) rotate(8deg);
        filter: drop-shadow(0 2px 8px #222);
    }
    #backpackBtn:hover #backpackIcon {
        transform: scale(1.18) rotate(-8deg);
        filter: drop-shadow(0 4px 16px #44f);
    }
    #backpackBtn:active #backpackIcon {
        transform: scale(0.92) rotate(8deg);
        filter: drop-shadow(0 2px 8px #222);
    }
    </style>
</head>
<body>
<button id="backpackBtn" style="position:absolute;top:50%;left:10px;transform:translateY(-50%);z-index:11;width:56px;height:56px;padding:0;background:transparent;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;">
    <img src="assets/backpack.png" id="backpackIcon" alt="Backpack" style="width:48px;height:48px;transition:transform 0.18s cubic-bezier(.5,2,.5,1);filter:drop-shadow(0 2px 8px #222);">
</button>
<button id="castBtn" style="position:absolute;top:20px;left:50%;transform:translateX(-50%);z-index:10;font-size:24px;padding:10px 30px;">Cast</button>
<div id="inventoryModal" style="display:none;position:absolute;top:50%;left:76px;transform:translateY(-50%);z-index:100;width:240px;">
  <div id="inventoryModalInner" style="background:#222;padding:16px 12px;border-radius:14px;box-shadow:0 4px 24px #000;min-width:90px;max-width:240px;width:240px;max-height:320px;overflow-y:auto;display:flex;flex-direction:column;align-items:center;position:relative;transition:opacity 0.5s;">
    <div id="inventoryGrid" style="display:grid;grid-template-columns:repeat(4, 1fr);gap:12px;width:100%;"></div>
  </div>
</div>
<script>
function getGameSize() {
    const w = window.innerWidth;
    const h = window.innerHeight;
    let width = w;
    let height = Math.round(w * 9 / 16);
    if (height > h) {
        height = h;
        width = Math.round(h * 16 / 9);
    }
    return { width, height };
}

let game;
let player, fishGroup, fishCount = 0, rodLevel = 1;
let fishText, upgradeText, statusText;
let isCasting = false;
let fishTypes = [
    { name: 'Bluegill', price: 1, weight: 7 },
    { name: 'Crappie', price: 2, weight: 5 },
    { name: 'Catfish', price: 2, weight: 5 },
    { name: 'Smallmouth bass', price: 5, weight: 2 },
    { name: 'Largemouth bass', price: 7, weight: 1 }
];
let inventory = {
    'Bluegill': 0,
    'Crappie': 0,
    'Catfish': 0,
    'Smallmouth bass': 0,
    'Largemouth bass': 0
};
let inventoryText;

function createGame() {
    const size = getGameSize();
    const config = {
        type: Phaser.AUTO,
        width: size.width,
        height: size.height,
        scene: {
            preload: preload,
            create: create,
            update: update
        },
        physics: {
            default: 'arcade',
            arcade: { gravity: { y: 0 } }
        }
    };
    game = new Phaser.Game(config);
}

window.addEventListener('resize', () => {
    if (game) {
        const size = getGameSize();
        game.scale.resize(size.width, size.height);
    }
});



document.getElementById('castBtn').addEventListener('click', () => {
    if (!isCasting) {
        castRod();
    }
});


// Ensure badge is created and initialized to 0 before game starts
function createInventoryBadge() {
    let badge = document.getElementById('inventoryBadge');
    if (!badge) {
        badge = document.createElement('span');
        badge.id = 'inventoryBadge';
        badge.style.position = 'absolute';
        badge.style.left = '38px';
        badge.style.top = '6px';
        badge.style.minWidth = '22px';
        badge.style.height = '22px';
        badge.style.background = '#44f';
        badge.style.color = '#fff';
        badge.style.fontSize = '16px';
        badge.style.fontWeight = 'bold';
        badge.style.borderRadius = '50%';
        badge.style.display = 'flex';
        badge.style.alignItems = 'center';
        badge.style.justifyContent = 'center';
        badge.style.boxShadow = '0 2px 8px #222';
        badge.style.zIndex = '12';
        badge.style.pointerEvents = 'none';
        badge.style.transition = 'transform 0.18s cubic-bezier(.5,2,.5,1)';
        badge.textContent = '0';
        document.getElementById('backpackBtn').appendChild(badge);
    }
}

// Create total value display under backpack button
function createTotalValueDisplay() {
    let valueDiv = document.getElementById('totalValueDiv');
    if (!valueDiv) {
        valueDiv = document.createElement('div');
        valueDiv.id = 'totalValueDiv';
        valueDiv.style.position = 'absolute';
        valueDiv.style.left = '10px';
        valueDiv.style.top = 'calc(50% + 36px)';
        valueDiv.style.transform = 'translateY(-50%)';
        valueDiv.style.zIndex = '11';
        valueDiv.style.color = '#fff';
        valueDiv.style.fontSize = '18px';
        valueDiv.style.fontWeight = 'bold';
        valueDiv.style.textShadow = '0 2px 8px #222';
        valueDiv.textContent = 'Total Value: $0';
        document.body.appendChild(valueDiv);
    }
    updateTotalValueDisplay();
}

function updateTotalValueDisplay() {
    let totalValue = 0;
    for (let f of fishTypes) {
        totalValue += inventory[f.name] * f.price;
    }
    let valueDiv = document.getElementById('totalValueDiv');
    if (valueDiv) {
        valueDiv.textContent = `$${totalValue}`;
    }
}

createInventoryBadge();
createTotalValueDisplay();
createGame();

let inventoryFadeTimeout = null;
let isMouseOverInventory = false;

function showInventoryModal() {
    updateModalInventoryGrid();
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    modal.style.display = 'block';
    inner.style.opacity = '1';
    clearTimeout(inventoryFadeTimeout);
    setupInventoryFade();
}

function setupInventoryFade() {
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    // Mouse events
    inner.onmouseenter = () => {
        isMouseOverInventory = true;
        clearTimeout(inventoryFadeTimeout);
        inner.style.opacity = '1';
    };
    inner.onmouseleave = () => {
        isMouseOverInventory = false;
        startInventoryFadeTimer();
    };
    startInventoryFadeTimer();
}

function startInventoryFadeTimer() {
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    clearTimeout(inventoryFadeTimeout);
    inventoryFadeTimeout = setTimeout(() => {
        if (!isMouseOverInventory && modal.style.display !== 'none') {
            inner.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                inner.style.opacity = '1';
                hideItemDetailPanel();
            }, 500);
        }
    }, 5000);
}

document.getElementById('backpackBtn').addEventListener('click', () => {
    showInventoryModal();
    // Click animation: briefly scale down and up
    const icon = document.getElementById('backpackIcon');
    icon.style.transition = 'transform 0.12s cubic-bezier(.5,2,.5,1)';
    icon.style.transform = 'scale(0.92) rotate(8deg)';
    setTimeout(() => {
        icon.style.transition = 'transform 0.18s cubic-bezier(.5,2,.5,1)';
        icon.style.transform = '';
    }, 120);
});

// Close inventory when clicking outside
document.addEventListener('mousedown', function(e) {
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    if (modal.style.display !== 'none' && !inner.contains(e.target) && e.target.id !== 'backpackBtn' && e.target.id !== 'backpackIcon') {
        modal.style.display = 'none';
        hideItemDetailPanel();
    }
});

// Remove closeInventoryBtn logic (no close button)

// Fish descriptions and icons
const fishDetails = {
    'Bluegill': {
        icon: 'assets/greenFish.png',
        desc: 'A common panfish found in lakes. Tasty and easy to catch.',
        large: 'assets/greenFish.png'
    },
    'Crappie': {
        icon: 'assets/greenFish.png',
        desc: 'Small but valuable. Crappie are prized by anglers for their flavor.',
        large: 'assets/greenFish.png'
    },
    'Catfish': {
        icon: 'assets/greenFish.png',
        desc: 'Bottom-dwelling fish known for their whiskers and resilience.',
        large: 'assets/greenFish.png'
    },
    'Smallmouth bass': {
        icon: 'assets/greenFish.png',
        desc: 'A feisty fighter, smallmouth bass are fun to catch and delicious.',
        large: 'assets/greenFish.png'
    },
    'Largemouth bass': {
        icon: 'assets/greenFish.png',
        desc: 'The trophy catch! Largemouth bass are the kings of freshwater.',
        large: 'assets/greenFish.png'
    }
};

function updateModalInventoryGrid() {
    let grid = document.getElementById('inventoryGrid');
    grid.innerHTML = '';
    let hasItems = false;
    for (let f of fishTypes) {
        let count = inventory[f.name];
        if (count <= 0) continue;
        hasItems = true;
        let details = fishDetails[f.name];
        let itemDiv = document.createElement('div');
        itemDiv.className = 'inventoryItem';
        itemDiv.style.position = 'relative';
        itemDiv.style.width = '48px';
        itemDiv.style.height = '48px';
        itemDiv.style.display = 'flex';
        itemDiv.style.alignItems = 'center';
        itemDiv.style.justifyContent = 'center';
        itemDiv.style.cursor = 'pointer';
        // Hover for detail panel
        itemDiv.onmouseenter = function(e) {
            showItemDetailPanel(f.name, details, count, f.price, itemDiv);
        };
        itemDiv.onmouseleave = function() {
            hideItemDetailPanel();
        };
        let img = document.createElement('img');
        img.src = details.icon;
        img.style.width = '40px';
        img.style.height = '40px';
        img.style.borderRadius = '8px';
        img.style.boxShadow = '0 2px 8px #222';
        itemDiv.appendChild(img);
        let badge = document.createElement('span');
        badge.textContent = count;
        badge.style.position = 'absolute';
        badge.style.right = '2px';
        badge.style.bottom = '2px';
        badge.style.minWidth = '18px';
        badge.style.height = '18px';
        badge.style.background = '#44f';
        badge.style.color = '#fff';
        badge.style.fontSize = '13px';
        badge.style.fontWeight = 'bold';
        badge.style.borderRadius = '50%';
        badge.style.display = 'flex';
        badge.style.alignItems = 'center';
        badge.style.justifyContent = 'center';
        badge.style.boxShadow = '0 2px 8px #222';
        badge.style.pointerEvents = 'none';
        itemDiv.appendChild(badge);
        grid.appendChild(itemDiv);
    }
    if (!hasItems) {
        let emptyMsg = document.createElement('div');
        emptyMsg.textContent = 'Inventory is empty';
        emptyMsg.style.color = '#aaa';
        emptyMsg.style.fontSize = '18px';
        emptyMsg.style.fontWeight = 'bold';
        emptyMsg.style.textAlign = 'center';
        emptyMsg.style.gridColumn = '1 / -1';
        emptyMsg.style.margin = '32px 0';
        grid.appendChild(emptyMsg);
    }
}

// Create floating detail panel on hover
let detailPanel = null;
function showItemDetailPanel(name, details, count, price, anchorDiv) {
    hideItemDetailPanel();
    detailPanel = document.createElement('div');
    detailPanel.style.position = 'fixed';
    const rect = anchorDiv.getBoundingClientRect();
    detailPanel.style.left = (rect.right + 12) + 'px';
    detailPanel.style.top = (rect.top - 8) + 'px';
    detailPanel.style.background = '#222';
    detailPanel.style.borderRadius = '16px';
    detailPanel.style.boxShadow = '0 4px 32px #000';
    detailPanel.style.padding = '24px';
    detailPanel.style.zIndex = '999';
    detailPanel.style.display = 'flex';
    detailPanel.style.flexDirection = 'column';
    detailPanel.style.alignItems = 'center';
    detailPanel.style.minWidth = '180px';
    detailPanel.style.maxWidth = '260px';
    // Large image
    let img = document.createElement('img');
    img.src = details.large;
    img.style.width = '96px';
    img.style.height = '96px';
    img.style.marginBottom = '12px';
    img.style.borderRadius = '12px';
    img.style.boxShadow = '0 2px 8px #222';
    detailPanel.appendChild(img);
    // Name
    let title = document.createElement('div');
    title.textContent = name;
    title.style.color = '#fff';
    title.style.fontSize = '22px';
    title.style.fontWeight = 'bold';
    title.style.marginBottom = '8px';
    detailPanel.appendChild(title);
    // Quantity
    let qty = document.createElement('div');
    qty.textContent = `Quantity: ${count}`;
    qty.style.color = '#8ff';
    qty.style.fontSize = '18px';
    qty.style.marginBottom = '8px';
    detailPanel.appendChild(qty);
    // Value
    let value = document.createElement('div');
    value.textContent = `Value: $${count * price} (${count} x $${price})`;
    value.style.color = '#fff';
    value.style.fontSize = '18px';
    value.style.marginBottom = '8px';
    detailPanel.appendChild(value);
    // Description
    let desc = document.createElement('div');
    desc.textContent = details.desc;
    desc.style.color = '#ccc';
    desc.style.fontSize = '16px';
    detailPanel.appendChild(desc);
    document.body.appendChild(detailPanel);
}
function hideItemDetailPanel() {
    if (detailPanel) {
        detailPanel.remove();
        detailPanel = null;
    }
}

function preload() {
    this.load.image('player', 'https://via.placeholder.com/32x32.png?text=P');
    this.load.image('fish', 'assets/greenFish.png');
}

function create() {
    player = this.physics.add.sprite(400, 200, 'player').setImmovable(true);
    fishGroup = this.physics.add.group();

    // Add label next to player sprite
    this.add.text(player.x + 40, player.y - 16, 'Fisher', { fontSize: '18px', color: '#fff' });
    this.input.on('pointerdown', upgradeRod, this);
}

function spawnFish() {
    const x = Phaser.Math.Between(300, 500);
    const fish = fishGroup.create(x, 500, 'fish').setVelocityY(-50);
    fish.setData('value', 1);
}

function catchFish(player, fish) {
    fish.destroy();
    fishCount += fish.getData('value');
    fishText.setText(`Fish: ${fishCount}`);
    updateUpgradeText();
}

function upgradeRod() {
    // Removed rod upgrade functionality
}

function updateUpgradeText() {
    // Removed rod upgrade text
}

// --- Fishing Mechanic ---
function castRod() {
    isCasting = true;
    document.getElementById('castBtn').disabled = true;
    // Animate rod down (move player sprite)
    let scene = game.scene.scenes[0];
    scene.tweens.add({
        targets: player,
        y: 400,
        duration: 500,
        onComplete: () => {
            // Wait random 1-5 seconds
            let waitTime = Phaser.Math.Between(1000, 5000);
            setTimeout(() => {
                // Animate rod up
                scene.tweens.add({
                    targets: player,
                    y: 200,
                    duration: 500,
                    onComplete: () => {
                        // Enable cast button immediately after rod returns
                        document.getElementById('castBtn').disabled = false;
                        isCasting = false;
                        revealCatch(scene);
                    }
                });
            }, waitTime);
        }
    });
}

function revealCatch(scene) {
    // Weighted random fish selection
    let totalWeight = fishTypes.reduce((sum, f) => sum + f.weight, 0);
    let rand = Math.random() * totalWeight;
    let selectedFish = null;
    for (let f of fishTypes) {
        if (rand < f.weight) {
            selectedFish = f;
            break;
        }
        rand -= f.weight;
    }
    let caught = selectedFish !== null && Math.random() < 0.7; // 70% chance to catch something
    if (caught) {
        inventory[selectedFish.name]++;
        // Show fish sprite next to player with label
        let fishSprite = scene.add.sprite(player.x + 60, player.y + 32, 'fish');
        scene.add.text(player.x + 80, player.y + 16, selectedFish.name, { fontSize: '18px', color: '#fff' });
        setTimeout(() => fishSprite.destroy(), 1200);
    }
    updateInventoryText();
    updateTotalValueDisplay();
}

function updateInventoryText() {
    let totalCount = Object.values(inventory).reduce((a, b) => a + b, 0);
    let badge = document.getElementById('inventoryBadge');
    if (badge) {
        badge.textContent = totalCount;
    }
    updateTotalValueDisplay();
}

function update() {
    fishGroup.getChildren().forEach(fish => {
        if (fish.y < 300) fish.destroy();
    });
}
</script>
</body>
</html>