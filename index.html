<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zombie Fishing</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    background: #2a3d55;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
}
body {
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #2a3d55;
}
        #gameContainer {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #333;
            overflow: hidden;
        }
        canvas {
            display: block;
            margin: 0 auto;
            background: #333;
        }
        #backpackBtn:hover #backpackIcon {
            transform: scale(1.18) rotate(-8deg);
            filter: drop-shadow(0 4px 16px #44f);
        }
        #backpackBtn:active #backpackIcon {
            transform: scale(0.92) rotate(8deg);
            filter: drop-shadow(0 2px 8px #222);
        }
        #backpackBtn:hover #backpackIcon {
            transform: scale(1.18) rotate(-8deg);
            filter: drop-shadow(0 4px 16px #44f);
        }
        #backpackBtn:active #backpackIcon {
            transform: scale(0.92) rotate(8deg);
            filter: drop-shadow(0 2px 8px #222);
        }
    </style>
</head>
<body>
<div id="gameContainer"></div>
<script>
function resizeGameContainer() {
    // Get window size
    const w = window.innerWidth;
    const h = window.innerHeight;
    // Calculate max 16:9 area
    let gameW = w;
    let gameH = Math.round(w * 9 / 16);
    if (gameH > h) {
        gameH = h;
        gameW = Math.round(h * 16 / 9);
    }
    const gameContainer = document.getElementById('gameContainer');
    gameContainer.style.width = gameW + 'px';
    gameContainer.style.height = gameH + 'px';
    gameContainer.style.left = ((w - gameW) / 2) + 'px';
    gameContainer.style.top = ((h - gameH) / 2) + 'px';
    gameContainer.style.position = 'absolute';
}
window.addEventListener('resize', resizeGameContainer);
window.addEventListener('DOMContentLoaded', resizeGameContainer);

// Move UI elements into gameContainer
function setupGameContainerUI() {
    const gameContainer = document.getElementById('gameContainer');
    // Move canvas into container after Phaser creates it
    const moveCanvas = () => {
        const canvas = document.querySelector('canvas');
        if (canvas && canvas.parentElement !== gameContainer) {
            gameContainer.appendChild(canvas);
        }
    };
    // Create/move UI elements
    let backpackBtn = document.getElementById('backpackBtn');
    if (!backpackBtn) {
        backpackBtn = document.createElement('button');
        backpackBtn.id = 'backpackBtn';
        backpackBtn.style.position = 'absolute';
        backpackBtn.style.zIndex = '11';
        backpackBtn.style.padding = '0';
        backpackBtn.style.background = 'transparent';
        backpackBtn.style.border = 'none';
        backpackBtn.style.cursor = 'pointer';
        backpackBtn.style.display = 'flex';
        backpackBtn.style.alignItems = 'center';
        backpackBtn.style.justifyContent = 'center';
        let backpackIcon = document.createElement('img');
        backpackIcon.src = 'assets/backpack.png';
        backpackIcon.id = 'backpackIcon';
        backpackIcon.alt = 'Backpack';
        backpackIcon.style.transition = 'transform 0.18s cubic-bezier(.5,2,.5,1)';
        backpackIcon.style.filter = 'drop-shadow(0 2px 8px #222)';
        backpackBtn.appendChild(backpackIcon);
        gameContainer.appendChild(backpackBtn);
    } else if (backpackBtn.parentElement !== gameContainer) {
        gameContainer.appendChild(backpackBtn);
    }
    // Ensure badge is created and initialized to 0 before game starts
    let badge = document.getElementById('inventoryBadge');
    if (!badge) {
        badge = document.createElement('span');
        badge.id = 'inventoryBadge';
        badge.style.position = 'absolute';
        badge.style.left = '38px';
        badge.style.top = '6px';
        badge.style.minWidth = '22px';
        badge.style.height = '22px';
        badge.style.background = '#44f';
        badge.style.color = '#fff';
        badge.style.fontSize = '16px';
        badge.style.fontWeight = 'bold';
        badge.style.borderRadius = '50%';
        badge.style.display = 'flex';
        badge.style.alignItems = 'center';
        badge.style.justifyContent = 'center';
        badge.style.boxShadow = '0 2px 8px #222';
        badge.style.zIndex = '12';
        badge.style.pointerEvents = 'none';
        badge.style.transition = 'transform 0.18s cubic-bezier(.5,2,.5,1)';
        badge.textContent = '0';
        backpackBtn.appendChild(badge);
    }
    // Backpack button event listener
    backpackBtn.onclick = function() {
        showInventoryModal();
        // Click animation: briefly scale down and up
        const icon = document.getElementById('backpackIcon');
        icon.style.transition = 'transform 0.12s cubic-bezier(.5,2,.5,1)';
        icon.style.transform = 'scale(0.92) rotate(8deg)';
        setTimeout(() => {
            icon.style.transition = 'transform 0.18s cubic-bezier(.5,2,.5,1)';
            icon.style.transform = '';
        }, 120);
    };
    let castBtn = document.getElementById('castBtn');
    if (!castBtn) {
        castBtn = document.createElement('button');
        castBtn.id = 'castBtn';
        castBtn.textContent = 'Cast';
        castBtn.style.position = 'absolute';
        castBtn.style.zIndex = '10';
        gameContainer.appendChild(castBtn);
    } else if (castBtn.parentElement !== gameContainer) {
        gameContainer.appendChild(castBtn);
    }
    // Always set up event listener after creation/move
    castBtn.onclick = function() {
        if (!isCasting) {
            castRod();
        }
    };
    let inventoryModal = document.getElementById('inventoryModal');
    if (!inventoryModal) {
        inventoryModal = document.createElement('div');
        inventoryModal.id = 'inventoryModal';
        inventoryModal.style.position = 'absolute';
        inventoryModal.style.zIndex = '100';
        inventoryModal.style.display = 'none';
        let inner = document.createElement('div');
        inner.id = 'inventoryModalInner';
        inner.style.position = 'relative';
        inner.style.background = '#333';
        inner.style.borderRadius = '14px';
        inner.style.boxShadow = '0 4px 32px #000';
        let grid = document.createElement('div');
        grid.id = 'inventoryGrid';
        inner.appendChild(grid);
        inventoryModal.appendChild(inner);
        gameContainer.appendChild(inventoryModal);
    } else if (inventoryModal.parentElement !== gameContainer) {
        gameContainer.appendChild(inventoryModal);
    }
    moveCanvas();
}
function getGameSize() {
    const w = window.innerWidth;
    const h = window.innerHeight;
    let width = w;
    let height = Math.round(w * 9 / 16);
    if (height > h) {
        height = h;
        width = Math.round(h * 16 / 9);
    }
    return { width, height };
}

let game;
let player, fishGroup, fishCount = 0, rodLevel = 1;
let fisherText, fishText, upgradeText, statusText;
let isCasting = false;
let fishTypes = [
    { name: 'Bluegill', price: 1, weight: 7 },
    { name: 'Crappie', price: 2, weight: 5 },
    { name: 'Catfish', price: 2, weight: 5 },
    { name: 'Smallmouth bass', price: 5, weight: 2 },
    { name: 'Largemouth bass', price: 7, weight: 1 }
];
let inventory = {
    'Bluegill': 0,
    'Crappie': 0,
    'Catfish': 0,
    'Smallmouth bass': 0,
    'Largemouth bass': 0
};
let inventoryText;
let scaleFactor = 1;

function scaleUIElements() {
    // Backpack button and icon
    const backpackBtn = document.getElementById('backpackBtn');
    const backpackIcon = document.getElementById('backpackIcon');
    if (backpackBtn && backpackIcon) {
        backpackBtn.style.width = (56 * scaleFactor) + 'px';
        backpackBtn.style.height = (56 * scaleFactor) + 'px';
        backpackIcon.style.width = (48 * scaleFactor) + 'px';
        backpackIcon.style.height = (48 * scaleFactor) + 'px';
    }
    // Inventory badge
    const badge = document.getElementById('inventoryBadge');
    if (badge) {
        badge.style.left = (38 * scaleFactor) + 'px';
        badge.style.top = (6 * scaleFactor) + 'px';
        badge.style.minWidth = (22 * scaleFactor) + 'px';
        badge.style.height = (22 * scaleFactor) + 'px';
        badge.style.fontSize = (16 * scaleFactor) + 'px';
    }
    // Cast button
    const castBtn = document.getElementById('castBtn');
    if (castBtn) {
        castBtn.style.fontSize = (24 * scaleFactor) + 'px';
        castBtn.style.padding = (10 * scaleFactor) + 'px ' + (30 * scaleFactor) + 'px';
    }
    // Total value display
    const valueDiv = document.getElementById('totalValueDiv');
    if (valueDiv) {
        valueDiv.style.left = (10 * scaleFactor) + 'px';
        valueDiv.style.top = 'calc(50% + ' + (36 * scaleFactor) + 'px)';
        valueDiv.style.fontSize = (18 * scaleFactor) + 'px';
    }
    // Inventory modal and grid
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    const grid = document.getElementById('inventoryGrid');
    if (modal && inner && grid) {
        modal.style.width = (240 * scaleFactor) + 'px';
        inner.style.padding = (16 * scaleFactor) + 'px ' + (12 * scaleFactor) + 'px';
        inner.style.borderRadius = (14 * scaleFactor) + 'px';
        inner.style.minWidth = (90 * scaleFactor) + 'px';
        inner.style.maxWidth = (240 * scaleFactor) + 'px';
        inner.style.width = (240 * scaleFactor) + 'px';
        inner.style.maxHeight = (320 * scaleFactor) + 'px';
        grid.style.gap = (12 * scaleFactor) + 'px';
    }
    // Inventory items
    if (grid) {
        Array.from(grid.children).forEach(itemDiv => {
            if (itemDiv.className === 'inventoryItem') {
                itemDiv.style.width = (48 * scaleFactor) + 'px';
                itemDiv.style.height = (48 * scaleFactor) + 'px';
                const img = itemDiv.querySelector('img');
                if (img) {
                    img.style.width = (40 * scaleFactor) + 'px';
                    img.style.height = (40 * scaleFactor) + 'px';
                    img.style.borderRadius = (8 * scaleFactor) + 'px';
                }
                const badge = itemDiv.querySelector('span');
                if (badge) {
                    badge.style.minWidth = (18 * scaleFactor) + 'px';
                    badge.style.height = (18 * scaleFactor) + 'px';
                    badge.style.fontSize = (13 * scaleFactor) + 'px';
                }
            } else if (itemDiv.textContent === 'Inventory is empty') {
                itemDiv.style.fontSize = (18 * scaleFactor) + 'px';
                itemDiv.style.margin = (32 * scaleFactor) + 'px 0';
            }
        });
    }
}

function createGame() {
    const size = getGameSize();
    scaleFactor = size.width / 800; // 800 is the original base width
    const config = {
        type: Phaser.AUTO,
        width: size.width,
        height: size.height,
        scene: {
            preload: preload,
            create: create,
            update: update
        },
        physics: {
            default: 'arcade',
            arcade: { gravity: { y: 0 } }
        }
    };
    game = new Phaser.Game(config);
    // Wait for Phaser canvas to be created before scaling UI and game objects
    setTimeout(() => {
        scaleUIElements();
        setupGameContainerUI();
        positionUIElements();
        updatePhaserTextPositions();
    }, 0);
}

window.addEventListener('resize', () => {
    if (game) {
        const size = getGameSize();
        scaleFactor = size.width / 800;
        game.scale.resize(size.width, size.height);
        // Update sprite scales and positions on resize
        if (player) {
            player.setScale(scaleFactor);
            player.setPosition(size.width * 0.5, size.height * 0.25);
        }
        if (fishGroup) {
            fishGroup.getChildren().forEach(fish => {
                fish.setScale(scaleFactor);
            });
        }
        scaleUIElements();
        positionUIElements();
        updatePhaserTextPositions();
    }
});
// Position UI elements relative to game window
function positionUIElements() {
    const gameContainer = document.getElementById('gameContainer');
    const canvas = gameContainer.querySelector('canvas');
    if (!canvas) return;
    const rect = canvas.getBoundingClientRect();
    // Backpack button
    const backpackBtn = document.getElementById('backpackBtn');
    if (backpackBtn) {
        backpackBtn.style.left = (10 * scaleFactor) + 'px';
        backpackBtn.style.top = (rect.height * 0.5 - 28 * scaleFactor) + 'px';
        backpackBtn.style.transform = '';
    }
    // Cast button
    const castBtn = document.getElementById('castBtn');
    if (castBtn) {
        castBtn.style.left = (rect.width * 0.5 - (castBtn.offsetWidth / 2)) + 'px';
        castBtn.style.top = (20 * scaleFactor) + 'px';
        castBtn.style.transform = '';
    }
    // Inventory modal
    const inventoryModal = document.getElementById('inventoryModal');
    if (inventoryModal) {
        inventoryModal.style.left = (76 * scaleFactor) + 'px';
        inventoryModal.style.top = (rect.height * 0.5 - (parseFloat(inventoryModal.style.height || 0) / 2)) + 'px';
        inventoryModal.style.transform = '';
    }
    // Total value display
    const valueDiv = document.getElementById('totalValueDiv');
    if (valueDiv) {
        valueDiv.style.left = (10 * scaleFactor) + 'px';
        valueDiv.style.top = (rect.height * 0.5 + 36 * scaleFactor) + 'px';
        valueDiv.style.transform = 'translateY(-50%)';
    }
}



// Ensure badge is created and initialized to 0 before game starts

// Create total value display under backpack button
function createTotalValueDisplay() {
    let valueDiv = document.getElementById('totalValueDiv');
    const gameContainer = document.getElementById('gameContainer');
    if (!valueDiv) {
        valueDiv = document.createElement('div');
        valueDiv.id = 'totalValueDiv';
        valueDiv.style.position = 'absolute';
        valueDiv.style.zIndex = '11';
        valueDiv.style.color = '#fff';
        valueDiv.style.fontWeight = 'bold';
        valueDiv.style.textShadow = '0 2px 8px #222';
        valueDiv.textContent = 'Total Value: $0';
        gameContainer.appendChild(valueDiv);
    }
    updateTotalValueDisplay();
}

function updateTotalValueDisplay() {
    let totalValue = 0;
    for (let f of fishTypes) {
        totalValue += inventory[f.name] * f.price;
    }
    let valueDiv = document.getElementById('totalValueDiv');
    if (valueDiv) {
        valueDiv.textContent = `$${totalValue}`;
        // Position and scale
        const gameContainer = document.getElementById('gameContainer');
        const canvas = gameContainer.querySelector('canvas');
        if (canvas) {
            const rect = canvas.getBoundingClientRect();
            valueDiv.style.left = (10 * scaleFactor) + 'px';
            valueDiv.style.top = (rect.height * 0.5 + 36 * scaleFactor) + 'px';
            valueDiv.style.transform = 'translateY(-50%)';
            valueDiv.style.fontSize = (18 * scaleFactor) + 'px';
        }
    }
}


// Delay UI setup until DOM is ready
window.addEventListener('DOMContentLoaded', () => {
    createTotalValueDisplay();
    createGame();
});

let inventoryFadeTimeout = null;
let isMouseOverInventory = false;

function showInventoryModal() {
    updateModalInventoryGrid();
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    modal.style.display = 'block';
    inner.style.opacity = '1';
    clearTimeout(inventoryFadeTimeout);
    setupInventoryFade();
}

function setupInventoryFade() {
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    // Mouse events
    inner.onmouseenter = () => {
        isMouseOverInventory = true;
        clearTimeout(inventoryFadeTimeout);
        inner.style.opacity = '1';
    };
    inner.onmouseleave = () => {
        isMouseOverInventory = false;
        startInventoryFadeTimer();
    };
    startInventoryFadeTimer();
}

function startInventoryFadeTimer() {
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    clearTimeout(inventoryFadeTimeout);
    inventoryFadeTimeout = setTimeout(() => {
        if (!isMouseOverInventory && modal.style.display !== 'none') {
            inner.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                inner.style.opacity = '1';
                hideItemDetailPanel();
            }, 500);
        }
    }, 5000);
}


// Close inventory when clicking outside
document.addEventListener('mousedown', function(e) {
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    if (modal.style.display !== 'none' && !inner.contains(e.target) && e.target.id !== 'backpackBtn' && e.target.id !== 'backpackIcon') {
        modal.style.display = 'none';
        hideItemDetailPanel();
    }
});

// Remove closeInventoryBtn logic (no close button)

// Fish descriptions and icons
const fishDetails = {
    'Bluegill': {
        icon: 'assets/greenFish.png',
        desc: 'A common panfish found in lakes. Tasty and easy to catch.',
        large: 'assets/greenFish.png'
    },
    'Crappie': {
        icon: 'assets/greenFish.png',
        desc: 'Small but valuable. Crappie are prized by anglers for their flavor.',
        large: 'assets/greenFish.png'
    },
    'Catfish': {
        icon: 'assets/greenFish.png',
        desc: 'Bottom-dwelling fish known for their whiskers and resilience.',
        large: 'assets/greenFish.png'
    },
    'Smallmouth bass': {
        icon: 'assets/greenFish.png',
        desc: 'A feisty fighter, smallmouth bass are fun to catch and delicious.',
        large: 'assets/greenFish.png'
    },
    'Largemouth bass': {
        icon: 'assets/greenFish.png',
        desc: 'The trophy catch! Largemouth bass are the kings of freshwater.',
        large: 'assets/greenFish.png'
    }
};

function updateModalInventoryGrid() {
    let grid = document.getElementById('inventoryGrid');
    grid.innerHTML = '';
    let hasItems = false;
    for (let f of fishTypes) {
        let count = inventory[f.name];
        if (count <= 0) continue;
        hasItems = true;
        let details = fishDetails[f.name];
        let itemDiv = document.createElement('div');
        itemDiv.className = 'inventoryItem';
        itemDiv.style.position = 'relative';
        itemDiv.style.width = (48 * scaleFactor) + 'px';
        itemDiv.style.height = (48 * scaleFactor) + 'px';
        itemDiv.style.display = 'flex';
        itemDiv.style.alignItems = 'center';
        itemDiv.style.justifyContent = 'center';
        itemDiv.style.cursor = 'pointer';
        // Hover for detail panel
        itemDiv.onmouseenter = function(e) {
            showItemDetailPanel(f.name, details, count, f.price, itemDiv);
        };
        itemDiv.onmouseleave = function() {
            hideItemDetailPanel();
        };
        let img = document.createElement('img');
        img.src = details.icon;
        img.style.width = (40 * scaleFactor) + 'px';
        img.style.height = (40 * scaleFactor) + 'px';
        img.style.borderRadius = (8 * scaleFactor) + 'px';
        img.style.boxShadow = '0 2px 8px #222';
        itemDiv.appendChild(img);
        let badge = document.createElement('span');
        badge.textContent = count;
        badge.style.position = 'absolute';
        badge.style.right = '2px';
        badge.style.bottom = '2px';
        badge.style.minWidth = (18 * scaleFactor) + 'px';
        badge.style.height = (18 * scaleFactor) + 'px';
        badge.style.background = '#44f';
        badge.style.color = '#fff';
        badge.style.fontSize = (13 * scaleFactor) + 'px';
        badge.style.fontWeight = 'bold';
        badge.style.borderRadius = '50%';
        badge.style.display = 'flex';
        badge.style.alignItems = 'center';
        badge.style.justifyContent = 'center';
        badge.style.boxShadow = '0 2px 8px #222';
        badge.style.pointerEvents = 'none';
        itemDiv.appendChild(badge);
        grid.appendChild(itemDiv);
    }
    if (!hasItems) {
        let emptyMsg = document.createElement('div');
        emptyMsg.textContent = 'Inventory is empty';
        emptyMsg.style.color = '#aaa';
        emptyMsg.style.fontSize = (18 * scaleFactor) + 'px';
        emptyMsg.style.fontWeight = 'bold';
        emptyMsg.style.textAlign = 'center';
        emptyMsg.style.gridColumn = '1 / -1';
        emptyMsg.style.margin = (32 * scaleFactor) + 'px 0';
        grid.appendChild(emptyMsg);
    }
}

// Create floating detail panel on hover
let detailPanel = null;
function showItemDetailPanel(name, details, count, price, anchorDiv) {
    hideItemDetailPanel();
    detailPanel = document.createElement('div');
    detailPanel.style.position = 'fixed';
    const rect = anchorDiv.getBoundingClientRect();
    detailPanel.style.left = (rect.right + 12) + 'px';
    detailPanel.style.top = (rect.top - 8) + 'px';
    detailPanel.style.background = '#222';
    detailPanel.style.borderRadius = '16px';
    detailPanel.style.boxShadow = '0 4px 32px #000';
    detailPanel.style.padding = '24px';
    detailPanel.style.zIndex = '999';
    detailPanel.style.display = 'flex';
    detailPanel.style.flexDirection = 'column';
    detailPanel.style.alignItems = 'center';
    detailPanel.style.minWidth = '180px';
    detailPanel.style.maxWidth = '260px';
    // Large image
    let img = document.createElement('img');
    img.src = details.large;
    img.style.width = '96px';
    img.style.height = '96px';
    img.style.marginBottom = '12px';
    img.style.borderRadius = '12px';
    img.style.boxShadow = '0 2px 8px #222';
    detailPanel.appendChild(img);
    // Name
    let title = document.createElement('div');
    title.textContent = name;
    title.style.color = '#fff';
    title.style.fontSize = '22px';
    title.style.fontWeight = 'bold';
    title.style.marginBottom = '8px';
    detailPanel.appendChild(title);
    // Quantity
    let qty = document.createElement('div');
    qty.textContent = `Quantity: ${count}`;
    qty.style.color = '#8ff';
    qty.style.fontSize = '18px';
    qty.style.marginBottom = '8px';
    detailPanel.appendChild(qty);
    // Value
    let value = document.createElement('div');
    value.textContent = `Value: $${count * price} (${count} x $${price})`;
    value.style.color = '#fff';
    value.style.fontSize = '18px';
    value.style.marginBottom = '8px';
    detailPanel.appendChild(value);
    // Description
    let desc = document.createElement('div');
    desc.textContent = details.desc;
    desc.style.color = '#ccc';
    desc.style.fontSize = '16px';
    detailPanel.appendChild(desc);
    document.body.appendChild(detailPanel);
}
function hideItemDetailPanel() {
    if (detailPanel) {
        detailPanel.remove();
        detailPanel = null;
    }
}

function preload() {
    this.load.image('player', 'https://via.placeholder.com/32x32.png?text=P');
    this.load.image('fish', 'assets/greenFish.png');
}

function create() {
    const size = getGameSize();
    player = this.physics.add.sprite(size.width * 0.5, size.height * 0.25, 'player').setImmovable(true);
    player.setScale(scaleFactor);
    fishGroup = this.physics.add.group();

    // Add label next to player sprite
    fisherText = this.add.text(player.x + 40 * scaleFactor, player.y - 16 * scaleFactor, 'Fisher', { fontSize: 18 * scaleFactor, color: '#fff' });
    this.input.on('pointerdown', upgradeRod, this);
}

function spawnFish() {
    const size = getGameSize();
    const x = Phaser.Math.Between(size.width * 0.375, size.width * 0.625);
    const fish = fishGroup.create(x, size.height * 0.8, 'fish').setVelocityY(-50 * scaleFactor);
    fish.setScale(scaleFactor);
    fish.setData('value', 1);
}

function catchFish(player, fish) {
    fish.destroy();
    fishCount += fish.getData('value');
    fishText.setText(`Fish: ${fishCount}`);
    updateUpgradeText();
}

function upgradeRod() {
    // Removed rod upgrade functionality
}

function updateUpgradeText() {
    // Removed rod upgrade text
}

// --- Fishing Mechanic ---
function castRod() {
    isCasting = true;
    document.getElementById('castBtn').disabled = true;
    // Animate rod down (move player sprite)
    let scene = game.scene.scenes[0];
    const size = getGameSize();
    scene.tweens.add({
        targets: player,
        y: size.height * 0.5,
        duration: 500,
        onComplete: () => {
            // Wait random 1-5 seconds
            let waitTime = Phaser.Math.Between(1000, 5000);
            setTimeout(() => {
                // Animate rod up
                scene.tweens.add({
                    targets: player,
                    y: size.height * 0.25,
                    duration: 500,
                    onComplete: () => {
                        // Enable cast button immediately after rod returns
                        document.getElementById('castBtn').disabled = false;
                        isCasting = false;
                        revealCatch(scene);
                    }
                });
            }, waitTime);
        }
    });
}

function revealCatch(scene) {
    // Weighted random fish selection
    let totalWeight = fishTypes.reduce((sum, f) => sum + f.weight, 0);
    let rand = Math.random() * totalWeight;
    let selectedFish = null;
    for (let f of fishTypes) {
        if (rand < f.weight) {
            selectedFish = f;
            break;
        }
        rand -= f.weight;
    }
    let caught = selectedFish !== null && Math.random() < 0.7; // 70% chance to catch something
    let resultText, resultTextObj;
    // Move text further left
    const textX = player.x - 140 * scaleFactor;
    const textY = player.y + 16 * scaleFactor;
    const moveDistance = 32 * scaleFactor; // Move less distance for slower effect
    const fadeDuration = 2200; // Slower fade and move
    if (caught) {
        inventory[selectedFish.name]++;
        resultText = `1+ ${selectedFish.name}`;
        resultTextObj = scene.add.text(textX, textY, resultText, {
            fontSize: 18 * scaleFactor,
            color: '#8ff',
            fontStyle: 'bold'
        });
        resultTextObj.setAlpha(1);
        // Animate up and fade out slower
        scene.tweens.add({
            targets: resultTextObj,
            y: resultTextObj.y - moveDistance,
            alpha: 0,
            duration: fadeDuration,
            ease: 'Cubic.easeOut',
            onComplete: () => resultTextObj.destroy()
        });
    } else {
        resultText = 'Nothing...';
        resultTextObj = scene.add.text(textX, textY, resultText, {
            fontSize: 18 * scaleFactor,
            color: '#faa',
            fontStyle: 'bold'
        });
        resultTextObj.setAlpha(1);
        // Animate down and fade out slower
        scene.tweens.add({
            targets: resultTextObj,
            y: resultTextObj.y + moveDistance,
            alpha: 0,
            duration: fadeDuration,
            ease: 'Cubic.easeIn',
            onComplete: () => resultTextObj.destroy()
        });
    }
    updateInventoryText();
    updateTotalValueDisplay();
}

function updateInventoryText() {
    let totalCount = Object.values(inventory).reduce((a, b) => a + b, 0);
    let badge = document.getElementById('inventoryBadge');
    if (badge) {
        badge.textContent = totalCount;
    }
    updateTotalValueDisplay();
}

function updatePhaserTextPositions() {
    const size = getGameSize();
    if (fisherText && player) {
        fisherText.setFontSize(18 * scaleFactor);
        fisherText.setPosition(player.x + 40 * scaleFactor, player.y - 16 * scaleFactor);
    }
    // Add more text objects here if needed
}

function update() {
    fishGroup.getChildren().forEach(fish => {
        if (fish.y < 300) fish.destroy();
    });
}
</script>
</body>
</html>