<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zombie Fishing</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.min.js"></script>
    <style>
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    background: #2a3d55;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
}
body {
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #2a3d55;
}
        #gameContainer {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #333;
            overflow: hidden;
        }
        canvas {
            display: block;
            margin: 0 auto;
            background: #333;
        }
        #backpackBtn:hover #backpackIcon {
            transform: scale(1.18) rotate(-8deg);
            filter: drop-shadow(0 4px 16px #44f);
        }
        #backpackBtn:active #backpackIcon {
            transform: scale(0.92) rotate(8deg);
            filter: drop-shadow(0 2px 8px #222);
        }
        #backpackBtn:hover #backpackIcon {
            transform: scale(1.18) rotate(-8deg);
            filter: drop-shadow(0 4px 16px #44f);
        }
        #backpackBtn:active #backpackIcon {
            transform: scale(0.92) rotate(8deg);
            filter: drop-shadow(0 2px 8px #222);
        }
    </style>
</head>
<body>
<div id="gameContainer"></div>
<script>
function resizeGameContainer() {
    // Get window size
    const w = window.innerWidth;
    const h = window.innerHeight;
    // Calculate max 16:9 area
    let gameW = w;
    let gameH = Math.round(w * 9 / 16);
    if (gameH > h) {
        gameH = h;
        gameW = Math.round(h * 16 / 9);
    }
    const gameContainer = document.getElementById('gameContainer');
    gameContainer.style.width = gameW + 'px';
    gameContainer.style.height = gameH + 'px';
    gameContainer.style.left = ((w - gameW) / 2) + 'px';
    gameContainer.style.top = ((h - gameH) / 2) + 'px';
    gameContainer.style.position = 'absolute';
}
window.addEventListener('resize', resizeGameContainer);
window.addEventListener('DOMContentLoaded', resizeGameContainer);

// Move UI elements into gameContainer
function setupGameContainerUI() {
    const gameContainer = document.getElementById('gameContainer');
    // Move canvas into container after Phaser creates it
    const moveCanvas = () => {
        const canvas = document.querySelector('canvas');
        if (canvas && canvas.parentElement !== gameContainer) {
            gameContainer.appendChild(canvas);
        }
    };
    // Create/move UI elements
    let backpackBtn = document.getElementById('backpackBtn');
    if (!backpackBtn) {
        backpackBtn = document.createElement('button');
        backpackBtn.id = 'backpackBtn';
        backpackBtn.style.position = 'absolute';
        backpackBtn.style.zIndex = '11';
        backpackBtn.style.padding = '0';
        backpackBtn.style.background = 'transparent';
        backpackBtn.style.border = 'none';
        backpackBtn.style.cursor = 'pointer';
        backpackBtn.style.display = 'flex';
        backpackBtn.style.alignItems = 'center';
        backpackBtn.style.justifyContent = 'center';
        let backpackIcon = document.createElement('img');
        backpackIcon.src = 'assets/backpack.png';
        backpackIcon.id = 'backpackIcon';
        backpackIcon.alt = 'Backpack';
        backpackIcon.style.transition = 'transform 0.18s cubic-bezier(.5,2,.5,1)';
        backpackIcon.style.filter = 'drop-shadow(0 2px 8px #222)';
        backpackBtn.appendChild(backpackIcon);
        gameContainer.appendChild(backpackBtn);
    } else if (backpackBtn.parentElement !== gameContainer) {
        gameContainer.appendChild(backpackBtn);
    }
    // Ensure badge is created and initialized to 0 before game starts
    let badge = document.getElementById('inventoryBadge');
    if (!badge) {
        badge = document.createElement('span');
        badge.id = 'inventoryBadge';
        badge.style.position = 'absolute';
        badge.style.left = '38px';
        badge.style.top = '6px';
        badge.style.minWidth = '22px';
        badge.style.height = '22px';
        badge.style.background = '#44f';
        badge.style.color = '#fff';
        badge.style.fontSize = '16px';
        badge.style.fontWeight = 'bold';
        badge.style.borderRadius = '50%';
        badge.style.display = 'flex';
        badge.style.alignItems = 'center';
        badge.style.justifyContent = 'center';
        badge.style.boxShadow = '0 2px 8px #222';
        badge.style.zIndex = '12';
        badge.style.pointerEvents = 'none';
        badge.style.transition = 'transform 0.18s cubic-bezier(.5,2,.5,1)';
        badge.textContent = '0';
        backpackBtn.appendChild(badge);
    }
    // Backpack button event listener
    backpackBtn.onclick = function() {
        showInventoryModal();
        // Click animation: briefly scale down and up
        const icon = document.getElementById('backpackIcon');
        icon.style.transition = 'transform 0.12s cubic-bezier(.5,2,.5,1)';
        icon.style.transform = 'scale(0.92) rotate(8deg)';
        setTimeout(() => {
            icon.style.transition = 'transform 0.18s cubic-bezier(.5,2,.5,1)';
            icon.style.transform = '';
        }, 120);
    };
    let castBtn = document.getElementById('castBtn');
    if (!castBtn) {
        castBtn = document.createElement('button');
        castBtn.id = 'castBtn';
        castBtn.textContent = 'Cast';
        castBtn.style.position = 'absolute';
        castBtn.style.zIndex = '10';
        gameContainer.appendChild(castBtn);
    } else if (castBtn.parentElement !== gameContainer) {
        gameContainer.appendChild(castBtn);
    }
    // Always set up event listener after creation/move
    castBtn.onclick = function() {
        if (!isCasting) {
            castRod();
        }
    };
    let inventoryModal = document.getElementById('inventoryModal');
    if (!inventoryModal) {
        inventoryModal = document.createElement('div');
        inventoryModal.id = 'inventoryModal';
        inventoryModal.style.position = 'absolute';
        inventoryModal.style.zIndex = '100';
        inventoryModal.style.display = 'none';
        let inner = document.createElement('div');
        inner.id = 'inventoryModalInner';
        inner.style.position = 'relative';
        inner.style.background = '#333';
        inner.style.borderRadius = '14px';
        inner.style.boxShadow = '0 4px 32px #000';
        let grid = document.createElement('div');
        grid.id = 'inventoryGrid';
        inner.appendChild(grid);
        inventoryModal.appendChild(inner);
        gameContainer.appendChild(inventoryModal);
    } else if (inventoryModal.parentElement !== gameContainer) {
        gameContainer.appendChild(inventoryModal);
    }
    moveCanvas();
}
function getGameSize() {
    const w = window.innerWidth;
    const h = window.innerHeight;
    let width = w;
    let height = Math.round(w * 9 / 16);
    if (height > h) {
        height = h;
        width = Math.round(h * 16 / 9);
    }
    return { width, height };
}

let game;
let player, fishGroup, fishCount = 0, rodLevel = 1;
let fisherText, fishText, upgradeText, statusText;
let isCasting = false;
let fishTypes = [
    { name: 'Bluegill', price: 1, weight: 7 },
    { name: 'Crappie', price: 2, weight: 5 },
    { name: 'Catfish', price: 2, weight: 5 },
    { name: 'Smallmouth bass', price: 5, weight: 2 },
    { name: 'Largemouth bass', price: 7, weight: 1 }
];
let inventory = {
    'Bluegill': 0,
    'Crappie': 0,
    'Catfish': 0,
    'Smallmouth bass': 0,
    'Largemouth bass': 0
};
let inventoryText;
let scaleFactor = 1;
let playerCash = 0;
let isMarketScreen = false;

function scaleUIElements() {
    // Backpack button and icon
    const backpackBtn = document.getElementById('backpackBtn');
    const backpackIcon = document.getElementById('backpackIcon');
    if (backpackBtn && backpackIcon) {
        backpackBtn.style.width = (56 * scaleFactor) + 'px';
        backpackBtn.style.height = (56 * scaleFactor) + 'px';
        backpackIcon.style.width = (48 * scaleFactor) + 'px';
        backpackIcon.style.height = (48 * scaleFactor) + 'px';
    }
    // Inventory badge
    const badge = document.getElementById('inventoryBadge');
    if (badge) {
        badge.style.left = (38 * scaleFactor) + 'px';
        badge.style.top = (6 * scaleFactor) + 'px';
        badge.style.minWidth = (22 * scaleFactor) + 'px';
        badge.style.height = (22 * scaleFactor) + 'px';
        badge.style.fontSize = (16 * scaleFactor) + 'px';
    }
    // Cast button
    const castBtn = document.getElementById('castBtn');
    if (castBtn) {
        castBtn.style.fontSize = (24 * scaleFactor) + 'px';
        castBtn.style.padding = (10 * scaleFactor) + 'px ' + (30 * scaleFactor) + 'px';
        castBtn.style.display = isMarketScreen ? 'none' : '';
    }
    // Cash display
    const cashDiv = document.getElementById('cashDiv');
    if (cashDiv) {
        cashDiv.style.left = (18 * scaleFactor) + 'px';
        cashDiv.style.top = (18 * scaleFactor) + 'px';
        cashDiv.style.fontSize = (28 * scaleFactor) + 'px';
        cashDiv.style.padding = (8 * scaleFactor) + 'px ' + (24 * scaleFactor) + 'px';
        cashDiv.style.borderRadius = (12 * scaleFactor) + 'px';
    }
    // Market button
    const marketBtn = document.getElementById('marketBtn');
    if (marketBtn) {
        marketBtn.style.right = (24 * scaleFactor) + 'px';
        marketBtn.style.top = (scaleFactor * 0.5 * window.innerHeight) + 'px';
        marketBtn.style.fontSize = (32 * scaleFactor) + 'px';
        marketBtn.style.padding = (18 * scaleFactor) + 'px ' + (44 * scaleFactor) + 'px';
        marketBtn.style.borderRadius = (18 * scaleFactor) + 'px';
        marketBtn.style.display = isMarketScreen ? 'none' : '';
    }
    // Return button
    const returnBtn = document.getElementById('returnBtn');
    if (returnBtn) {
        returnBtn.style.left = (24 * scaleFactor) + 'px';
        returnBtn.style.top = (scaleFactor * 0.5 * window.innerHeight) + 'px';
        returnBtn.style.fontSize = (32 * scaleFactor) + 'px';
        returnBtn.style.padding = (18 * scaleFactor) + 'px ' + (44 * scaleFactor) + 'px';
        returnBtn.style.borderRadius = (18 * scaleFactor) + 'px';
        returnBtn.style.display = isMarketScreen ? '' : 'none';
    }
    // Total value display
    const valueDiv = document.getElementById('totalValueDiv');
    if (valueDiv) {
        valueDiv.style.left = (10 * scaleFactor) + 'px';
        valueDiv.style.top = 'calc(50% + ' + (36 * scaleFactor) + 'px)';
        valueDiv.style.fontSize = (18 * scaleFactor) + 'px';
    }
    // Inventory modal and grid
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    const grid = document.getElementById('inventoryGrid');
    if (modal && inner && grid) {
        modal.style.width = (240 * scaleFactor) + 'px';
        inner.style.padding = (16 * scaleFactor) + 'px ' + (12 * scaleFactor) + 'px';
        inner.style.borderRadius = (14 * scaleFactor) + 'px';
        inner.style.minWidth = (90 * scaleFactor) + 'px';
        inner.style.maxWidth = (240 * scaleFactor) + 'px';
        inner.style.width = (240 * scaleFactor) + 'px';
        inner.style.maxHeight = (320 * scaleFactor) + 'px';
        grid.style.gap = (12 * scaleFactor) + 'px';
    }
    // Inventory items
    if (grid) {
        Array.from(grid.children).forEach(itemDiv => {
            if (itemDiv.className === 'inventoryItem') {
                itemDiv.style.width = (48 * scaleFactor) + 'px';
                itemDiv.style.height = (48 * scaleFactor) + 'px';
                const img = itemDiv.querySelector('img');
                if (img) {
                    img.style.width = (40 * scaleFactor) + 'px';
                    img.style.height = (40 * scaleFactor) + 'px';
                    img.style.borderRadius = (8 * scaleFactor) + 'px';
                }
                const badge = itemDiv.querySelector('span');
                if (badge) {
                    badge.style.minWidth = (18 * scaleFactor) + 'px';
                    badge.style.height = (18 * scaleFactor) + 'px';
                    badge.style.fontSize = (13 * scaleFactor) + 'px';
                }
            } else if (itemDiv.textContent === 'Inventory is empty') {
                itemDiv.style.fontSize = (18 * scaleFactor) + 'px';
                itemDiv.style.margin = (32 * scaleFactor) + 'px 0';
            }
        });
    }
    // Hide Phaser canvas in market screen
    const gameContainer = document.getElementById('gameContainer');
    const canvas = gameContainer.querySelector('canvas');
    if (canvas) {
        canvas.style.display = isMarketScreen ? 'none' : '';
    }
}

function createGame() {
    const size = getGameSize();
    scaleFactor = size.width / 800; // 800 is the original base width
    const config = {
        type: Phaser.AUTO,
        width: size.width,
        height: size.height,
        scene: {
            preload: preload,
            create: create,
            update: update
        },
        physics: {
            default: 'arcade',
            arcade: { gravity: { y: 0 } }
        }
    };
    game = new Phaser.Game(config);
    // Wait for Phaser canvas to be created before scaling UI and game objects
    setTimeout(() => {
        scaleUIElements();
        setupGameContainerUI();
        positionUIElements();
        updatePhaserTextPositions();
    }, 0);
}

window.addEventListener('resize', () => {
    if (game) {
        const size = getGameSize();
        scaleFactor = size.width / 800;
        game.scale.resize(size.width, size.height);
        // Update sprite scales and positions on resize
        if (player) {
            player.setScale(scaleFactor);
            player.setPosition(size.width * 0.5, size.height * 0.25);
        }
        if (fishGroup) {
            fishGroup.getChildren().forEach(fish => {
                fish.setScale(scaleFactor);
            });
        }
        scaleUIElements();
        positionUIElements();
        updatePhaserTextPositions();
    }
});
// Position UI elements relative to game window
function positionUIElements() {
    const gameContainer = document.getElementById('gameContainer');
    const canvas = gameContainer.querySelector('canvas');
    if (!canvas) return;
    const rect = canvas.getBoundingClientRect();
    // Backpack button
    const backpackBtn = document.getElementById('backpackBtn');
    if (backpackBtn) {
        backpackBtn.style.left = (10 * scaleFactor) + 'px';
        backpackBtn.style.top = (rect.height * 0.5 - 28 * scaleFactor) + 'px';
        backpackBtn.style.transform = '';
    }
    // Cast button
    const castBtn = document.getElementById('castBtn');
    if (castBtn) {
        castBtn.style.left = (rect.width * 0.5 - (castBtn.offsetWidth / 2)) + 'px';
        castBtn.style.top = (20 * scaleFactor) + 'px';
        castBtn.style.transform = '';
    }
    // Cash display
    const cashDiv = document.getElementById('cashDiv');
    if (cashDiv) {
        cashDiv.style.left = (18 * scaleFactor) + 'px';
        cashDiv.style.top = (18 * scaleFactor) + 'px';
        cashDiv.style.transform = '';
    }
    // Market button
    const marketBtn = document.getElementById('marketBtn');
    if (marketBtn) {
        marketBtn.style.right = (24 * scaleFactor) + 'px';
        marketBtn.style.top = (rect.height * 0.5 - (marketBtn.offsetHeight / 2)) + 'px';
        marketBtn.style.transform = '';
    }
    // Inventory modal
    const inventoryModal = document.getElementById('inventoryModal');
    if (inventoryModal) {
        inventoryModal.style.left = (76 * scaleFactor) + 'px';
        inventoryModal.style.top = (rect.height * 0.5 - (parseFloat(inventoryModal.style.height || 0) / 2)) + 'px';
        inventoryModal.style.transform = '';
    }
    // Total value display
    const valueDiv = document.getElementById('totalValueDiv');
    if (valueDiv) {
        valueDiv.style.left = (10 * scaleFactor) + 'px';
        valueDiv.style.top = (rect.height * 0.5 + 36 * scaleFactor) + 'px';
        valueDiv.style.transform = 'translateY(-50%)';
    }
}



// Ensure badge is created and initialized to 0 before game starts

// Create total value display under backpack button
function createTotalValueDisplay() {
    let valueDiv = document.getElementById('totalValueDiv');
    const gameContainer = document.getElementById('gameContainer');
    if (!valueDiv) {
        valueDiv = document.createElement('div');
        valueDiv.id = 'totalValueDiv';
        valueDiv.style.position = 'absolute';
        valueDiv.style.zIndex = '11';
        valueDiv.style.color = '#fff';
        valueDiv.style.fontWeight = 'bold';
        valueDiv.style.textShadow = '0 2px 8px #222';
        valueDiv.textContent = 'Total Value: $0';
        gameContainer.appendChild(valueDiv);
    }
    updateTotalValueDisplay();
}

function updateTotalValueDisplay() {
    let totalValue = 0;
    for (let f of fishTypes) {
        totalValue += inventory[f.name] * f.price;
    }
    let valueDiv = document.getElementById('totalValueDiv');
    if (valueDiv) {
        valueDiv.textContent = `$${totalValue}`;
        // Position and scale
        const gameContainer = document.getElementById('gameContainer');
        const canvas = gameContainer.querySelector('canvas');
        if (canvas) {
            const rect = canvas.getBoundingClientRect();
            valueDiv.style.left = (10 * scaleFactor) + 'px';
            valueDiv.style.top = (rect.height * 0.5 + 36 * scaleFactor) + 'px';
            valueDiv.style.transform = 'translateY(-50%)';
            valueDiv.style.fontSize = (18 * scaleFactor) + 'px';
        }
    }
}


// Delay UI setup until DOM is ready
window.addEventListener('DOMContentLoaded', () => {
    createTotalValueDisplay();
    createGame();
});

// Create cash display in top left
function createCashDisplay() {
    let cashDiv = document.getElementById('cashDiv');
    const gameContainer = document.getElementById('gameContainer');
    if (!cashDiv) {
        cashDiv = document.createElement('div');
        cashDiv.id = 'cashDiv';
        cashDiv.style.position = 'absolute';
        cashDiv.style.zIndex = '20';
        cashDiv.style.color = '#fff';
        cashDiv.style.fontWeight = 'bold';
        cashDiv.style.textShadow = '0 2px 8px #222';
        cashDiv.style.background = 'rgba(34,34,34,0.85)';
        cashDiv.style.padding = '8px 24px';
        cashDiv.style.borderRadius = '12px';
        cashDiv.textContent = `$${playerCash}`;
        gameContainer.appendChild(cashDiv);
    }
    updateCashDisplay();
}

function updateCashDisplay() {
    let cashDiv = document.getElementById('cashDiv');
    if (cashDiv) {
        cashDiv.textContent = `$${playerCash}`;
        // Position and scale
        cashDiv.style.left = (18 * scaleFactor) + 'px';
        cashDiv.style.top = (18 * scaleFactor) + 'px';
        cashDiv.style.fontSize = (28 * scaleFactor) + 'px';
        cashDiv.style.padding = (8 * scaleFactor) + 'px ' + (24 * scaleFactor) + 'px';
        cashDiv.style.borderRadius = (12 * scaleFactor) + 'px';
    }
}

// Create market button on right
function createMarketButton() {
    let marketBtn = document.getElementById('marketBtn');
    const gameContainer = document.getElementById('gameContainer');
    if (!marketBtn) {
        marketBtn = document.createElement('button');
        marketBtn.id = 'marketBtn';
        marketBtn.textContent = 'Market';
        marketBtn.style.position = 'absolute';
        marketBtn.style.zIndex = '20';
        marketBtn.style.background = 'linear-gradient(90deg,#44f,#4fc3f7)';
        marketBtn.style.color = '#fff';
        marketBtn.style.fontWeight = 'bold';
        marketBtn.style.fontSize = '32px';
        marketBtn.style.padding = '18px 44px';
        marketBtn.style.border = 'none';
        marketBtn.style.borderRadius = '18px';
        marketBtn.style.cursor = 'pointer';
        marketBtn.style.boxShadow = '0 4px 32px #222';
        marketBtn.style.right = '24px';
        marketBtn.style.top = '50%';
        marketBtn.style.transform = 'translateY(-50%)';
        marketBtn.onclick = function() {
            showMarketModal();
        };
        gameContainer.appendChild(marketBtn);
    }
}

// Create market modal
function createMarketModal() {
    let marketModal = document.getElementById('marketModal');
    const gameContainer = document.getElementById('gameContainer');
    if (!marketModal) {
        marketModal = document.createElement('div');
        marketModal.id = 'marketModal';
        marketModal.style.position = 'absolute';
        marketModal.style.zIndex = '100';
        marketModal.style.display = 'none';
        marketModal.style.left = '50%';
        marketModal.style.top = '50%';
        marketModal.style.transform = 'translate(-50%,-50%)';
        marketModal.style.background = '#222';
        marketModal.style.borderRadius = '18px';
        marketModal.style.boxShadow = '0 4px 32px #000';
        marketModal.style.padding = '32px 24px';
        marketModal.style.minWidth = '340px';
        marketModal.style.maxWidth = '480px';
        marketModal.style.color = '#fff';
        // Title
        let title = document.createElement('div');
        title.textContent = 'Market';
        title.style.fontSize = '32px';
        title.style.fontWeight = 'bold';
        title.style.marginBottom = '18px';
        marketModal.appendChild(title);
        // Fish selling section
        let sellSection = document.createElement('div');
        sellSection.style.marginBottom = '24px';
        sellSection.innerHTML = '<div style="font-size:22px;font-weight:bold;margin-bottom:8px;">Sell Fish</div>';
        let sellList = document.createElement('div');
        for (let f of fishTypes) {
            let count = inventory[f.name];
            if (count > 0) {
                let row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.marginBottom = '8px';
                let nameDiv = document.createElement('div');
                nameDiv.textContent = f.name;
                nameDiv.style.flex = '1';
                nameDiv.style.fontSize = '18px';
                let qtyDiv = document.createElement('div');
                qtyDiv.textContent = `x${count}`;
                qtyDiv.style.margin = '0 12px';
                let priceDiv = document.createElement('div');
                priceDiv.textContent = `$${f.price}`;
                priceDiv.style.margin = '0 12px';
                let sellBtn = document.createElement('button');
                sellBtn.textContent = 'Sell';
                sellBtn.style.background = '#44f';
                sellBtn.style.color = '#fff';
                sellBtn.style.border = 'none';
                sellBtn.style.borderRadius = '8px';
                sellBtn.style.padding = '6px 18px';
                sellBtn.style.cursor = 'pointer';
                sellBtn.onclick = function() {
                    playerCash += f.price;
                    inventory[f.name]--;
                    updateCashDisplay();
                    updateInventoryText();
                    showMarketModal();
                };
                row.appendChild(nameDiv);
                row.appendChild(qtyDiv);
                row.appendChild(priceDiv);
                row.appendChild(sellBtn);
                sellList.appendChild(row);
            }
        }
        if (sellList.children.length === 0) {
            let emptyMsg = document.createElement('div');
            emptyMsg.textContent = 'No fish to sell.';
            emptyMsg.style.color = '#aaa';
            emptyMsg.style.fontSize = '18px';
            emptyMsg.style.fontWeight = 'bold';
            emptyMsg.style.textAlign = 'center';
            emptyMsg.style.margin = '16px 0';
            sellList.appendChild(emptyMsg);
        }
        sellSection.appendChild(sellList);
        marketModal.appendChild(sellSection);
        // Buy items section (placeholder)
        let buySection = document.createElement('div');
        buySection.innerHTML = '<div style="font-size:22px;font-weight:bold;margin-bottom:8px;">Buy Items</div>';
        let buyList = document.createElement('div');
        // Example item
        let itemRow = document.createElement('div');
        itemRow.style.display = 'flex';
        itemRow.style.alignItems = 'center';
        itemRow.style.marginBottom = '8px';
        let itemName = document.createElement('div');
        itemName.textContent = 'Fishing Hat';
        itemName.style.flex = '1';
        itemName.style.fontSize = '18px';
        let itemPrice = document.createElement('div');
        itemPrice.textContent = '$10';
        itemPrice.style.margin = '0 12px';
        let buyBtn = document.createElement('button');
        buyBtn.textContent = 'Buy';
        buyBtn.style.background = '#4fc3f7';
        buyBtn.style.color = '#fff';
        buyBtn.style.border = 'none';
        buyBtn.style.borderRadius = '8px';
        buyBtn.style.padding = '6px 18px';
        buyBtn.style.cursor = 'pointer';
        buyBtn.onclick = function() {
            if (playerCash >= 10) {
                playerCash -= 10;
                updateCashDisplay();
                alert('You bought a Fishing Hat!');
            } else {
                alert('Not enough cash!');
            }
        };
        itemRow.appendChild(itemName);
        itemRow.appendChild(itemPrice);
        itemRow.appendChild(buyBtn);
        buyList.appendChild(itemRow);
        buySection.appendChild(buyList);
        marketModal.appendChild(buySection);
        // Close button
        let closeBtn = document.createElement('button');
        closeBtn.textContent = 'Close';
        closeBtn.style.background = '#333';
        closeBtn.style.color = '#fff';
        closeBtn.style.border = 'none';
        closeBtn.style.borderRadius = '8px';
        closeBtn.style.padding = '8px 24px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.marginTop = '18px';
        closeBtn.onclick = function() {
            marketModal.style.display = 'none';
        };
        marketModal.appendChild(closeBtn);
        gameContainer.appendChild(marketModal);
    }
}

function showMarketModal() {

// Hide all fishing UI elements
const fishingUIIds = ['backpackBtn', 'castBtn', 'cashDiv', 'marketBtn', 'totalValueDiv', 'inventoryModal'];
for (const id of fishingUIIds) {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
}
// Hide Phaser canvas
const gameContainer = document.getElementById('gameContainer');
const canvas = gameContainer.querySelector('canvas');
if (canvas) canvas.style.display = 'none';

// Create or show full-screen market panel
let marketPanel = document.getElementById('marketPanel');
if (!marketPanel) {
    marketPanel = document.createElement('div');
    marketPanel.id = 'marketPanel';
    marketPanel.style.position = 'absolute';
    marketPanel.style.left = '0';
    marketPanel.style.top = '0';
    marketPanel.style.width = '100%';
    marketPanel.style.height = '100%';
    marketPanel.style.background = 'linear-gradient(135deg,#222 60%,#44f 100%)';
    marketPanel.style.zIndex = '200';
    marketPanel.style.display = 'flex';
    marketPanel.style.flexDirection = 'column';
    marketPanel.style.alignItems = 'center';
    marketPanel.style.justifyContent = 'center';
    gameContainer.appendChild(marketPanel);
}
marketPanel.innerHTML = '';

// Title
let title = document.createElement('div');
title.textContent = 'Market';
title.style.fontSize = '48px';
title.style.fontWeight = 'bold';
title.style.color = '#fff';
title.style.marginBottom = '32px';
marketPanel.appendChild(title);

// Fish selling section
let sellSection = document.createElement('div');
sellSection.style.marginBottom = '32px';
sellSection.style.background = 'rgba(34,34,34,0.85)';
sellSection.style.borderRadius = '18px';
sellSection.style.padding = '24px 32px';
sellSection.style.boxShadow = '0 4px 32px #000';
sellSection.innerHTML = '<div style="font-size:28px;font-weight:bold;margin-bottom:12px;color:#8ff;">Sell Fish</div>';
let sellList = document.createElement('div');
for (let f of fishTypes) {
    let count = inventory[f.name];
    if (count > 0) {
        let row = document.createElement('div');
        row.style.display = 'flex';
        row.style.alignItems = 'center';
        row.style.marginBottom = '12px';
        let nameDiv = document.createElement('div');
        nameDiv.textContent = f.name;
        nameDiv.style.flex = '1';
        nameDiv.style.fontSize = '22px';
        nameDiv.style.color = '#fff';
        let qtyDiv = document.createElement('div');
        qtyDiv.textContent = `x${count}`;
        qtyDiv.style.margin = '0 18px';
        qtyDiv.style.color = '#8ff';
        let priceDiv = document.createElement('div');
        priceDiv.textContent = `$${f.price}`;
        priceDiv.style.margin = '0 18px';
        priceDiv.style.color = '#fff';
        let sellBtn = document.createElement('button');
        sellBtn.textContent = 'Sell';
        sellBtn.style.background = '#44f';
        sellBtn.style.color = '#fff';
        sellBtn.style.border = 'none';
        sellBtn.style.borderRadius = '8px';
        sellBtn.style.padding = '10px 28px';
        sellBtn.style.fontSize = '20px';
        sellBtn.style.cursor = 'pointer';
        sellBtn.onclick = function() {
            playerCash += f.price;
            inventory[f.name]--;
            updateCashDisplay();
            updateInventoryText();
            showMarketModal();
        };
        row.appendChild(nameDiv);
        row.appendChild(qtyDiv);
        row.appendChild(priceDiv);
        row.appendChild(sellBtn);
        sellList.appendChild(row);
    }
}
if (sellList.children.length === 0) {
    let emptyMsg = document.createElement('div');
    emptyMsg.textContent = 'No fish to sell.';
    emptyMsg.style.color = '#aaa';
    emptyMsg.style.fontSize = '22px';
    emptyMsg.style.fontWeight = 'bold';
    emptyMsg.style.textAlign = 'center';
    emptyMsg.style.margin = '24px 0';
    sellList.appendChild(emptyMsg);
}
sellSection.appendChild(sellList);
marketPanel.appendChild(sellSection);

// Buy items section (placeholder)
let buySection = document.createElement('div');
buySection.style.background = 'rgba(34,34,34,0.85)';
buySection.style.borderRadius = '18px';
buySection.style.padding = '24px 32px';
buySection.style.boxShadow = '0 4px 32px #000';
buySection.style.marginBottom = '32px';
buySection.innerHTML = '<div style="font-size:28px;font-weight:bold;margin-bottom:12px;color:#4fc3f7;">Buy Items</div>';
let buyList = document.createElement('div');
let itemRow = document.createElement('div');
itemRow.style.display = 'flex';
itemRow.style.alignItems = 'center';
itemRow.style.marginBottom = '12px';
let itemName = document.createElement('div');
itemName.textContent = 'Fishing Hat';
itemName.style.flex = '1';
itemName.style.fontSize = '22px';
itemName.style.color = '#fff';
let itemPrice = document.createElement('div');
itemPrice.textContent = '$10';
itemPrice.style.margin = '0 18px';
itemPrice.style.color = '#fff';
let buyBtn = document.createElement('button');
buyBtn.textContent = 'Buy';
buyBtn.style.background = '#4fc3f7';
buyBtn.style.color = '#fff';
buyBtn.style.border = 'none';
buyBtn.style.borderRadius = '8px';
buyBtn.style.padding = '10px 28px';
buyBtn.style.fontSize = '20px';
buyBtn.style.cursor = 'pointer';
buyBtn.onclick = function() {
    if (playerCash >= 10) {
        playerCash -= 10;
        updateCashDisplay();
        alert('You bought a Fishing Hat!');
    } else {
        alert('Not enough cash!');
    }
};
itemRow.appendChild(itemName);
itemRow.appendChild(itemPrice);
itemRow.appendChild(buyBtn);
buyList.appendChild(itemRow);
buySection.appendChild(buyList);
marketPanel.appendChild(buySection);

// Return button
let returnBtn = document.createElement('button');
returnBtn.textContent = 'Return';
returnBtn.style.background = '#333';
returnBtn.style.color = '#fff';
returnBtn.style.border = 'none';
returnBtn.style.borderRadius = '12px';
returnBtn.style.padding = '16px 48px';
returnBtn.style.fontSize = '28px';
returnBtn.style.cursor = 'pointer';
returnBtn.style.marginTop = '24px';
returnBtn.onclick = function() {
    switchToFishingScreen();
};
marketPanel.appendChild(returnBtn);
marketPanel.style.display = 'flex';
}

// Close market when clicking outside
document.addEventListener('mousedown', function(e) {
    const marketModal = document.getElementById('marketModal');
    if (marketModal && marketModal.style.display !== 'none' && !marketModal.contains(e.target) && e.target.id !== 'marketBtn') {
        marketModal.style.display = 'none';
    }
});

let inventoryFadeTimeout = null;
let isMouseOverInventory = false;

function showInventoryModal() {
    updateModalInventoryGrid();
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    modal.style.display = 'block';
    inner.style.opacity = '1';
    clearTimeout(inventoryFadeTimeout);
    setupInventoryFade();
}

function setupInventoryFade() {
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    // Mouse events
    inner.onmouseenter = () => {
        isMouseOverInventory = true;
        clearTimeout(inventoryFadeTimeout);
        inner.style.opacity = '1';
    };
    inner.onmouseleave = () => {
        isMouseOverInventory = false;
        startInventoryFadeTimer();
    };
    startInventoryFadeTimer();
}

function startInventoryFadeTimer() {
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    clearTimeout(inventoryFadeTimeout);
    inventoryFadeTimeout = setTimeout(() => {
        if (!isMouseOverInventory && modal.style.display !== 'none') {
            inner.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                inner.style.opacity = '1';
                hideItemDetailPanel();
            }, 500);
        }
    }, 5000);
}


// Close inventory when clicking outside
document.addEventListener('mousedown', function(e) {
    const modal = document.getElementById('inventoryModal');
    const inner = document.getElementById('inventoryModalInner');
    if (modal.style.display !== 'none' && !inner.contains(e.target) && e.target.id !== 'backpackBtn' && e.target.id !== 'backpackIcon') {
        modal.style.display = 'none';
        hideItemDetailPanel();
    }
});

// Remove closeInventoryBtn logic (no close button)

// Fish descriptions and icons
const fishDetails = {
    'Bluegill': {
        icon: 'assets/greenFish.png',
        desc: 'A common panfish found in lakes. Tasty and easy to catch.',
        large: 'assets/greenFish.png'
    },
    'Crappie': {
        icon: 'assets/greenFish.png',
        desc: 'Small but valuable. Crappie are prized by anglers for their flavor.',
        large: 'assets/greenFish.png'
    },
    'Catfish': {
        icon: 'assets/greenFish.png',
        desc: 'Bottom-dwelling fish known for their whiskers and resilience.',
        large: 'assets/greenFish.png'
    },
    'Smallmouth bass': {
        icon: 'assets/greenFish.png',
        desc: 'A feisty fighter, smallmouth bass are fun to catch and delicious.',
        large: 'assets/greenFish.png'
    },
    'Largemouth bass': {
        icon: 'assets/greenFish.png',
        desc: 'The trophy catch! Largemouth bass are the kings of freshwater.',
        large: 'assets/greenFish.png'
    }
};

function updateModalInventoryGrid() {
    let grid = document.getElementById('inventoryGrid');
    grid.innerHTML = '';
    let hasItems = false;
    for (let f of fishTypes) {
        let count = inventory[f.name];
        if (count <= 0) continue;
        hasItems = true;
        let details = fishDetails[f.name];
        let itemDiv = document.createElement('div');
        itemDiv.className = 'inventoryItem';
        itemDiv.style.position = 'relative';
        itemDiv.style.width = (48 * scaleFactor) + 'px';
        itemDiv.style.height = (48 * scaleFactor) + 'px';
        itemDiv.style.display = 'flex';
        itemDiv.style.alignItems = 'center';
        itemDiv.style.justifyContent = 'center';
        itemDiv.style.cursor = 'pointer';
        // Hover for detail panel
        itemDiv.onmouseenter = function(e) {
            showItemDetailPanel(f.name, details, count, f.price, itemDiv);
        };
        itemDiv.onmouseleave = function() {
            hideItemDetailPanel();
        };
        let img = document.createElement('img');
        img.src = details.icon;
        img.style.width = (40 * scaleFactor) + 'px';
        img.style.height = (40 * scaleFactor) + 'px';
        img.style.borderRadius = (8 * scaleFactor) + 'px';
        img.style.boxShadow = '0 2px 8px #222';
        itemDiv.appendChild(img);
        let badge = document.createElement('span');
        badge.textContent = count;
        badge.style.position = 'absolute';
        badge.style.right = '2px';
        badge.style.bottom = '2px';
        badge.style.minWidth = (18 * scaleFactor) + 'px';
        badge.style.height = (18 * scaleFactor) + 'px';
        badge.style.background = '#44f';
        badge.style.color = '#fff';
        badge.style.fontSize = (13 * scaleFactor) + 'px';
        badge.style.fontWeight = 'bold';
        badge.style.borderRadius = '50%';
        badge.style.display = 'flex';
        badge.style.alignItems = 'center';
        badge.style.justifyContent = 'center';
        badge.style.boxShadow = '0 2px 8px #222';
        badge.style.pointerEvents = 'none';
        itemDiv.appendChild(badge);
        grid.appendChild(itemDiv);
    }
    if (!hasItems) {
        let emptyMsg = document.createElement('div');
        emptyMsg.textContent = 'Inventory is empty';
        emptyMsg.style.color = '#aaa';
        emptyMsg.style.fontSize = (18 * scaleFactor) + 'px';
        emptyMsg.style.fontWeight = 'bold';
        emptyMsg.style.textAlign = 'center';
        emptyMsg.style.gridColumn = '1 / -1';
        emptyMsg.style.margin = (32 * scaleFactor) + 'px 0';
        grid.appendChild(emptyMsg);
    }
}

// Create floating detail panel on hover
let detailPanel = null;
function showItemDetailPanel(name, details, count, price, anchorDiv) {
    hideItemDetailPanel();
    detailPanel = document.createElement('div');
    detailPanel.style.position = 'fixed';
    const rect = anchorDiv.getBoundingClientRect();
    detailPanel.style.left = (rect.right + 12) + 'px';
    detailPanel.style.top = (rect.top - 8) + 'px';
    detailPanel.style.background = '#222';
    detailPanel.style.borderRadius = '16px';
    detailPanel.style.boxShadow = '0 4px 32px #000';
    detailPanel.style.padding = '24px';
    detailPanel.style.zIndex = '999';
    detailPanel.style.display = 'flex';
    detailPanel.style.flexDirection = 'column';
    detailPanel.style.alignItems = 'center';
    detailPanel.style.minWidth = '180px';
    detailPanel.style.maxWidth = '260px';
    // Large image
    let img = document.createElement('img');
    img.src = details.large;
    img.style.width = '96px';
    img.style.height = '96px';
    img.style.marginBottom = '12px';
    img.style.borderRadius = '12px';
    img.style.boxShadow = '0 2px 8px #222';
    detailPanel.appendChild(img);
    // Name
    let title = document.createElement('div');
    title.textContent = name;
    title.style.color = '#fff';
    title.style.fontSize = '22px';
    title.style.fontWeight = 'bold';
    title.style.marginBottom = '8px';
    detailPanel.appendChild(title);
    // Quantity
    let qty = document.createElement('div');
    qty.textContent = `Quantity: ${count}`;
    qty.style.color = '#8ff';
    qty.style.fontSize = '18px';
    qty.style.marginBottom = '8px';
    detailPanel.appendChild(qty);
    // Value
    let value = document.createElement('div');
    value.textContent = `Value: $${count * price} (${count} x $${price})`;
    value.style.color = '#fff';
    value.style.fontSize = '18px';
    value.style.marginBottom = '8px';
    detailPanel.appendChild(value);
    // Description
    let desc = document.createElement('div');
    desc.textContent = details.desc;
    desc.style.color = '#ccc';
    desc.style.fontSize = '16px';
    detailPanel.appendChild(desc);
    document.body.appendChild(detailPanel);
}
function hideItemDetailPanel() {
    if (detailPanel) {
        detailPanel.remove();
        detailPanel = null;
    }
}

function preload() {
    this.load.image('player', 'https://via.placeholder.com/32x32.png?text=P');
    this.load.image('fish', 'assets/greenFish.png');
}

function create() {
    const size = getGameSize();
    player = this.physics.add.sprite(size.width * 0.5, size.height * 0.25, 'player').setImmovable(true);
    player.setScale(scaleFactor);
    fishGroup = this.physics.add.group();

    // Add label next to player sprite
    fisherText = this.add.text(player.x + 40 * scaleFactor, player.y - 16 * scaleFactor, 'Fisher', { fontSize: 18 * scaleFactor, color: '#fff' });
    this.input.on('pointerdown', upgradeRod, this);
}

function spawnFish() {
    const size = getGameSize();
    const x = Phaser.Math.Between(size.width * 0.375, size.width * 0.625);
    const fish = fishGroup.create(x, size.height * 0.8, 'fish').setVelocityY(-50 * scaleFactor);
    fish.setScale(scaleFactor);
    fish.setData('value', 1);
}

function catchFish(player, fish) {
    fish.destroy();
    fishCount += fish.getData('value');
    fishText.setText(`Fish: ${fishCount}`);
    updateUpgradeText();
}

function upgradeRod() {
    // Removed rod upgrade functionality
}

function updateUpgradeText() {
    // Removed rod upgrade text
}

// --- Fishing Mechanic ---
function castRod() {
    isCasting = true;
    document.getElementById('castBtn').disabled = true;
    // Animate rod down (move player sprite)
    let scene = game.scene.scenes[0];
    const size = getGameSize();
    scene.tweens.add({
        targets: player,
        y: size.height * 0.5,
        duration: 500,
        onComplete: () => {
            // Wait random 1-5 seconds
            let waitTime = Phaser.Math.Between(1000, 5000);
            setTimeout(() => {
                // Animate rod up
                scene.tweens.add({
                    targets: player,
                    y: size.height * 0.25,
                    duration: 500,
                    onComplete: () => {
                        // Enable cast button immediately after rod returns
                        document.getElementById('castBtn').disabled = false;
                        isCasting = false;
                        revealCatch(scene);
        createCashDisplay();
        createMarketButton();
        createMarketModal();
                    }
                });
            }, waitTime);
        }
    });
}

function revealCatch(scene) {
    // Weighted random fish selection
    let totalWeight = fishTypes.reduce((sum, f) => sum + f.weight, 0);
    let rand = Math.random() * totalWeight;
    let selectedFish = null;
    for (let f of fishTypes) {
        if (rand < f.weight) {
            selectedFish = f;
            break;
        }
        rand -= f.weight;
    }
    let caught = selectedFish !== null && Math.random() < 0.7; // 70% chance to catch something
    let resultText, resultTextObj;
    // Move text further left
    const textX = player.x - 140 * scaleFactor;
    const textY = player.y + 16 * scaleFactor;
    const moveDistance = 32 * scaleFactor; // Move less distance for slower effect
    const fadeDuration = 2200; // Slower fade and move
    if (caught) {
        inventory[selectedFish.name]++;
        resultText = `1+ ${selectedFish.name}`;
        resultTextObj = scene.add.text(textX, textY, resultText, {
            fontSize: 18 * scaleFactor,
            color: '#8ff',
            fontStyle: 'bold'
        });
        resultTextObj.setAlpha(1);
        // Animate up and fade out slower
        scene.tweens.add({
            targets: resultTextObj,
            y: resultTextObj.y - moveDistance,
            alpha: 0,
            duration: fadeDuration,
            ease: 'Cubic.easeOut',
            onComplete: () => resultTextObj.destroy()
        });
    } else {
        resultText = 'Nothing...';
        resultTextObj = scene.add.text(textX, textY, resultText, {
            fontSize: 18 * scaleFactor,
            color: '#faa',
            fontStyle: 'bold'
        });
        resultTextObj.setAlpha(1);
        // Animate down and fade out slower
        scene.tweens.add({
            targets: resultTextObj,
            y: resultTextObj.y + moveDistance,
            alpha: 0,
            duration: fadeDuration,
            ease: 'Cubic.easeIn',
            onComplete: () => resultTextObj.destroy()
        });
    }
    updateInventoryText();
    updateTotalValueDisplay();
}

function updateInventoryText() {
    let totalCount = Object.values(inventory).reduce((a, b) => a + b, 0);
    let badge = document.getElementById('inventoryBadge');
    if (badge) {
        badge.textContent = totalCount;
    }
    updateTotalValueDisplay();
    updateCashDisplay();
}

function updatePhaserTextPositions() {
    const size = getGameSize();
    if (fisherText && player) {
        fisherText.setFontSize(18 * scaleFactor);
        fisherText.setPosition(player.x + 40 * scaleFactor, player.y - 16 * scaleFactor);
    }
    // Add more text objects here if needed
}

function update() {
    fishGroup.getChildren().forEach(fish => {
        if (fish.y < 300) fish.destroy();
    });
}

function switchToMarketScreen() {
    isMarketScreen = true;
    scaleUIElements();
    showMarketModal();
}

function switchToFishingScreen() {
    isMarketScreen = false;
    scaleUIElements();
    // Hide marketPanel and show fishing UI
    let marketPanel = document.getElementById('marketPanel');
    if (marketPanel) marketPanel.style.display = 'none';
    // Show all fishing UI elements
    const fishingUIIds = ['backpackBtn', 'castBtn', 'cashDiv', 'marketBtn', 'totalValueDiv', 'inventoryModal'];
    for (const id of fishingUIIds) {
        const el = document.getElementById(id);
        if (el) el.style.display = '';
    }
    // Show Phaser canvas
    const gameContainer = document.getElementById('gameContainer');
    const canvas = gameContainer.querySelector('canvas');
    if (canvas) canvas.style.display = '';
    // Hide marketModal if present
    let marketModal = document.getElementById('marketModal');
    if (marketModal) marketModal.style.display = 'none';
}
</script>
</body>
</html>